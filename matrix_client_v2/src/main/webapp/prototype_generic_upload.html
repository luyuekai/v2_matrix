<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="The Matrix Components Framework">
  <meta name="author" content="LY">
  <title>Matrix</title>
  <link rel="shortcut icon" href="assets/self-owned/ico/favicon.png">
  <link rel="stylesheet" type="text/css" href="assets/reference/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="assets/reference/flat-ui/css/flat-ui.css">
  <link rel="stylesheet" type="text/css" href="assets/reference/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="assets/self-owned/css/matrix.css">

  <link rel="stylesheet" type="text/css" href="assets/reference/bootstrap-fileinput/css/fileinput.min.css" media="all">



</head>

<body>

  <div class="flat-matrix">
    <div class="app-container">
      <div class="row content-container">
        <div id="navDIV"></div>
        <!-- 应用左侧NAV导航，可以应用与assist，帮助，过滤等辅助组件，默认自动收缩扩展，支持悬停（点击右上角按钮切换）-->
        <div id="assistDIV"></div>
        <div class="container-fluid">
          <div class="side-body padding-top">

            <div id="contentDIV">
              <!-- Breadcrum Zone -->
              <ol class="breadcrumb" style="margin-top:-30px;margin-left:-30px">
                <li><a href="index.html">Home</a></li>
                <li class="active">Matrix Generic File Upload</li>
              </ol>
              <!-- Content Header  -->
              <h2><i class="fa fa-tasks"></i> Matrix Generic File Upload <small>{(This is matrix template + Generic Service!)}</small> </h2>

              <div>
                <div class="row">
                  <div class="col-md-12">
                    <div>
                      <div class="alert fresh-color " data-bind="css:alerts.styleClass,visible:alerts.resultVisible">
                        <button type="button" class="close" data-bind="click:alerts.resultVisible(false)" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <strong>
                            <span data-bind="text:alerts.resultTitle"></span>
                          </strong>
                        <span data-bind="text:alerts.resultSubTitle"></span>
                        <div data-bind="text:alerts.resultContent"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div data-bind="foreach:uploadedFileUrls">
                    <div class="col-xs-6">
                      <img data-bind="attr:{src:$data}" class="img-thumbnail">
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12">
                    <div>
                      <div class="card card-success">
                        <div class="card-header" style="height:50px">
                          <div class="card-title" style="padding: 8px 20px;">
                            <div class="title"><i class="fa fa-cogs"></i> Upload Setting:
                              <small>(Generic Upload Service will validate these setting parameters in the backend)</small>
                            </div>
                          </div>
                          <div class="clear-both"></div>
                        </div>
                        <div class="card-body no-padding">
                          <br>
                          <form class="form-horizontal">
                            <div class="form-group">
                              <label class="col-sm-2 control-label">
                                <span style="font-weight: bold;font-size: 1.1em;">your credential id:</span>
                                <i class="fa fa-asterisk" style="color: #E74C3C;"></i>
                              </label>
                              <div class="col-sm-4">
                                <input data-bind="value:key1" type="text" class="form-control" placeholder="">
                              </div>
                              <label class="col-sm-2 control-label">
                                <span style="font-weight: bold;font-size: 1.1em;">your system id</span>
                                <i class="fa fa-asterisk" style="color: #E74C3C;"></i>
                              </label>
                              <div class="col-sm-4">
                                <input data-bind="value:key2" type="text" class="form-control" placeholder="">
                              </div>
                            </div>
                            <div class="form-group">
                              <label class="col-sm-2 control-label">
                                <span style="font-weight: bold;font-size: 1.1em;">your module id:</span>
                                <i class="fa fa-asterisk" style="color: #E74C3C;"></i>
                              </label>
                              <div class="col-sm-4">
                                <input data-bind="value:key3" type="text" class="form-control" placeholder="">
                              </div>
                              <label class="col-sm-2 control-label">
                                <span style="font-weight: bold;font-size: 1.1em;">your function id</span>
                                <i class="fa fa-asterisk" style="color: #E74C3C;"></i>
                              </label>
                              <div class="col-sm-4">
                                <input data-bind="value:key4" type="text" class="form-control" placeholder="">
                              </div>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>



                <form class="form-horizontal">
                  <div class="form-group">
                    <div class="col-sm-12">
                      <input id="input-id" type="file" name="file">
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>


  <!-- /.container -->


  <script src="assets/reference/jquery/jquery-1.11.1.min.js"></script>
  <script src="assets/reference/jquery/jquery.json.js"></script>
  <script src="assets/reference/knockout.js/knockout-3.3.0.js"></script>
  <script src="assets/reference/jquery-tiny-pubsub/tiny-pubsub.js"></script>
  <script src="assets/reference/flat-ui/js/vendor/video.js"></script>
  <script src="assets/reference/flat-ui/js/flat-ui.min.js"></script>
  <script src="assets/reference/flat-ui/docs/assets/js/prettify.js"></script>
  <script src="assets/reference/flat-ui/docs/assets/js/application.js"></script>
  <script src="assets/reference/bootstrap-fileinput/js/fileinput.js"></script>
  <script src="assets/reference/bootstrap-fileinput/js/locales/zh.js"></script>
  <!-- Javascript for Matrix Self Owned -->
  <script src="assets/self-owned/js/generic/generic_algorithm.js"></script>
  <script src="assets/self-owned/js/generic/generic_cache.js"></script>
  <script src="assets/self-owned/js/generic/generic_charting.js"></script>
  <script src="assets/self-owned/js/generic/generic_csv.js"></script>
  <script src="assets/self-owned/js/generic/generic_cud.js"></script>
  <script src="assets/self-owned/js/generic/generic_modal.js"></script>
  <script src="assets/self-owned/js/generic/generic_prototype.js"></script>
  <script src="assets/self-owned/js/generic/generic_query.js"></script>
  <script src="assets/self-owned/js/generic/generic_table.js"></script>
  <script src="assets/self-owned/js/generic/generic_util.js"></script>
  <script src="assets/self-owned/js/generic/generic_validation.js"></script>

  <script>
    $(document).ready(function() {
      $('#assistDIV').load($.getRootPath() + '/assets/self-owned/html/assist/matrix_assist_sample.html');
    });
    $("#input-id").fileinput({
      uploadUrl: $.getServerRoot() + "/service_generic_query/GenericUploadService",
      previewFileIcon: '<i class="fa fa-file"></i>',
      uploadExtraData: function() {
        var obj = {
          'UNIQUE_ID': vm.key1(),
          'SYSTEM_ID': vm.key2(),
          'MODULE_ID': vm.key3(),
          'FUNCTION_ID': vm.key4()
        };
        return obj;
      },
      allowedFileExtensions: ["jpeg", "jpg", "png", "gif"],
      allowedPreviewTypes: null, // disable preview of standard types
      allowedPreviewMimeTypes: ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'], // allow content to be shown only for certain mime types
      previewFileIconSettings: {
        'docx': '<i class="fa fa-file-word-o text-primary"></i>',
        'xls': '<i class="fa fa-file-excel-o text-success"></i>',
        'xlsx': '<i class="fa fa-file-excel-o text-success"></i>',
        'pptx': '<i class="fa fa-file-powerpoint-o text-danger"></i>',
        'pdf': '<i class="fa fa-file-pdf-o text-danger"></i>',
        'zip': '<i class="fa fa-file-archive-o text-muted"></i>',
      },
      uploadAsync: true,
      maxFileSize: 2048,
      maxFileCount: 3,
      showBrowse: false,
      browseOnZoneClick: true
    });
    $('#input-id').on('filepreupload', function(event, data, previewId, index) {
      validation_before_upload(vm);
      console.log('File pre upload triggered');
    });
    $("#input-id").on('fileuploaded', function(event, data, previewId, index) {

      var form = data.form,
        files = data.files,
        extra = data.extra,
        response = data.response,
        reader = data.reader;

      console.log(response);
      $.dispatchGenericResponse(response, "SUCCESS_LISTENER", "FAILED_LISTENER");
      // $('#input-id').fileinput('clear');
      // $('#input-id').fileinput('reset');
    });


    $('#input-id').on('fileuploaderror', function(event, data, msg) {
      var form = data.form,
        files = data.files,
        extra = data.extra,
        response = data.response,
        reader = data.reader;
      console.log('File upload error');
      // get message
      console.log(msg);

      vm.alerts.warningResponse(msg, "Tips:", "[Upload File Error]");
    });
  </script>

  <script>
    $.subscribe("SUCCESS_LISTENER", successListener);
    $.subscribe("FAILED_LISTENER", failedListener);

    function failedListener() {
      if (arguments && arguments[1]) {
        var errorMessage = arguments[1].errorMessage;
        vm.alerts.errorResponse(errorMessage, "Server Service Error!", "Please read the message below:");
      }
    }

    function successListener() {
      if (arguments && arguments[1]) {
        vm.alerts.correctResponse("Return Upload Success Response", "Successed!", "Congratulations!");
        console.log("response context is:" + JSON.stringify(arguments[1]));

        // var demo_response = {
        //   "hasError": false,
        //   "errorMessage": null,
        //   "statusCode": 200,
        //   "status": "GENERIC_UPLOAD_SERVICE_SUCCESS!",
        //   "result": [{
        //     "id": 96,
        //     "createtime": 1474463563249,
        //     "stringalpha": "ops",
        //     "stringbeta": "scripter",
        //     "stringdelta": "notebook",
        //     "stringeta": "ops_1474463563211.jpg",
        //     "stringgamma": "uploadPageData",
        //     "stringkappa": "/matrix/upload/scripter/ops/notebook/uploadPageData/ops_1474463563211.jpg",
        //     "stringlambda": "/opt/matrix/upload/scripter/ops/notebook/uploadPageData",
        //     "stringlota": null,
        //     "stringomega": null,
        //     "stringtheta": null,
        //     "stringzeta": null,
        //     "type": "GENERIC_UPLOAD_FUNCTION",
        //     "valid": true,
        //     "children": []
        //   }]
        // }

        var img_url_path = $.getServerRoot() + "/service_generic_query" + arguments[1].result[0].stringkappa;
        console.log(img_url_path);

        if (vm) {
          vm.uploadedFileUrls.push(img_url_path);

        }
      }
    }
  </script>
  <script>
    function GenericUploadPageViewModel() {
      var self = this;
      self.key1 = ko.observable('ops');
      self.key2 = ko.observable('scripter');
      self.key3 = ko.observable('notebook');
      self.key4 = ko.observable('uploadPageData');
      self.alerts = new ResponseViewModel(); // This model is located in the generic_query.js

      self.uploadedFileUrls = ko.observableArray();
    }
    var vm = new GenericUploadPageViewModel();

    ko.applyBindings(vm, document.getElementById('notebookListViewModelDIV'));

    var validation_before_upload = function(vm) {
      if (vm.key1() && vm.key2() && vm.key3() && vm.key4()) {
        vm.alerts.resultVisible(false);
      } else {
        vm.alerts.warningResponse("Validation Error", "Tips:", "[Upload File Validation]");
        $('#input-id').fileinput('cancel');
        $('#input-id').fileinput('clear');
      }
    }
  </script>
</body>

</html>
